name: Build and Test mod_replace

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: write
  actions: read


jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ubuntu-version: ['20.04', '22.04', '24.04']
        apache-version: ['2.4']
        
    container:
      image: ubuntu:${{ matrix.ubuntu-version }}
      
    steps:
    - name: Install system dependencies
      run: |
        apt-get update -yq
        apt-get install -yq \
          build-essential \
          cmake \
          git \
          apache2-dev \
          libapr1-dev \
          libaprutil1-dev \
          valgrind \
          pkg-config \
          apache2 \
          curl
          
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure build environment
      run: |
        echo "CC=gcc" >> $GITHUB_ENV
        echo "CXX=g++" >> $GITHUB_ENV
        
    - name: Build project
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr
        make -j$(nproc)
        
    - name: Run tests
      run: |
        cd build
        # Run Aho-Corasick algorithm tests
        ./test_aho_corasick
        
        # Run standalone APR tests
        ./test_valgrind
        
        # Run CTest suite
        ctest --output-on-failure
        
    - name: Run memory leak tests
      run: |
        cd build
        make valgrind-aho-corasick
        
        # Check valgrind results
        if grep -q "ERROR SUMMARY: 0 errors" valgrind-aho-corasick.log; then
          echo "✅ No memory leaks detected"
        else
          echo "❌ Memory leaks detected"
          cat valgrind-aho-corasick.log
          exit 1
        fi
        
    
    - name: Package artifacts
      if: matrix.ubuntu-version == '22.04'
      run: |
        cd build
        mkdir -p artifacts
        cp mod_replace.so artifacts/
        cp libaho_corasick.a artifacts/
        
        # Create package info
        cat > artifacts/build-info.txt << EOF
        Build Information:
        - Ubuntu Version: ${{ matrix.ubuntu-version }}
        - Apache Version: ${{ matrix.apache-version }}
        - Build Date: $(date)
        - Git Commit: ${GITHUB_SHA}
        - Compiler: $(gcc --version | head -n1)
        EOF
        
    - name: Upload build artifacts
      if: matrix.ubuntu-version == '22.04'
      uses: actions/upload-artifact@v4
      with:
        name: mod_replace-ubuntu-${{ matrix.ubuntu-version }}
        path: build/artifacts/
        retention-days: 30

  build-rockylinux:
    name: Build on Rocky Linux 9
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9
      
    steps:
    - name: Install system dependencies
      run: |
        dnf update -y
        dnf groupinstall -y "Development Tools"
        dnf install -y \
          cmake \
          git \
          httpd-devel \
          apr-devel \
          apr-util-devel \
          valgrind \
          pkg-config \
          httpd \
          which file
          
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build project
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr
        make -j$(nproc)
        
    - name: Run tests
      run: |
        cd build
        ./test_aho_corasick
        ./test_valgrind
        ctest --output-on-failure
        
    - name: Run memory leak tests
      run: |
        cd build
        make valgrind-aho-corasick
        
        if grep -q "ERROR SUMMARY: 0 errors" valgrind-aho-corasick.log; then
          echo "✅ No memory leaks detected"
        else
          echo "❌ Memory leaks detected"
          cat valgrind-aho-corasick.log
          exit 1
        fi
        
    
    - name: Package artifacts
      run: |
        cd build
        mkdir -p artifacts
        cp mod_replace.so artifacts/
        cp libaho_corasick.a artifacts/
        
        cat > artifacts/build-info.txt << EOF
        Build Information:
        - OS: Rocky Linux 9
        - Build Date: $(date)
        - Git Commit: ${GITHUB_SHA}
        - Compiler: $(gcc --version | head -n1)
        EOF
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mod_replace-rockylinux-9
        path: build/artifacts/
        retention-days: 30

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-ubuntu]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run security scan with CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: c
        
    - name: Install dependencies for analysis
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2-dev libapr1-dev cmake build-essential
        
    - name: Build for analysis
      run: |
        mkdir build && cd build
        cmake ..
        make
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-rockylinux, security-scan]
    if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download Ubuntu artifacts
      uses: actions/download-artifact@v4
      with:
        name: mod_replace-ubuntu-22.04
        path: ./ubuntu-artifacts
        
    - name: Download Rocky Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: mod_replace-rockylinux-9  
        path: ./rockylinux-artifacts
        
    - name: Create release packages
      run: |
        # Create Ubuntu package
        cd ubuntu-artifacts
        tar -czf ../mod_replace-ubuntu-22.04.tar.gz *
        cd ..
        
        # Create Rocky Linux package
        cd rockylinux-artifacts
        tar -czf ../mod_replace-rockylinux-9.tar.gz *
        cd ..
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          mod_replace-ubuntu-22.04.tar.gz
          mod_replace-rockylinux-9.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload release assets (for published releases)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./mod_replace-ubuntu-22.04.tar.gz
        asset_name: mod_replace-ubuntu-22.04.tar.gz
        asset_content_type: application/gzip
        
    - name: Upload Rocky Linux release assets (for published releases)
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./mod_replace-rockylinux-9.tar.gz
        asset_name: mod_replace-rockylinux-9.tar.gz
        asset_content_type: application/gzip